<html>

  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!-- <script src='script.js'></script> -->
  </head>
  <body>

    <div class="container">
      <div class="card">
        <div class="card-header">
          <h1 class="text-center">RPM</h1>
        </div>

        <div class="card-body">
          <div class="form-row align-items-center">
            
          </div>

          <div id='grph1' class="col-lg-12">
            <canvas id="myCanvas"></canvas>
          </div>
        </div>

        <div class="card-footer">
           <p>Instrumentação Eletrônica - CECOMP - UNIVASF - 2017</p>
        </div>
      </div>
    </div>


    <script>
      function drawLineChart() {
        var url = "https://rpmreadapi.herokuapp.com/reads";

        var jsonData = $.ajax({
          url: url,
          dataType: 'json',
        }).done(function(results){
          
          var motors = {};
                      
          results.forEach(function(read) {
            if(motors[read.motor_number] == null) 
              motors[read.motor_number]= [];

            motors[read.motor_number].push(read);
          });
          
          var datasets = [];
          
          Object.keys(motors).forEach(function(currentKey) {

            var voltages = {}; 
            var data = [];

            motors[currentKey].forEach(function(read) {
              if(voltages[read.voltage] == null){
                voltages[read.voltage] = {};
                voltages[read.voltage]["rpm_indutive"] = [];
                voltages[read.voltage]["rpm_optic"]   = [];
              }

              voltages[read.voltage]["rpm_indutive"].push(read.rpm_indutivo);
              voltages[read.voltage]["rpm_optic"].push(read.rpm_optico);
            });
            
            // Calculates the mean of RPM in a voltage
            Object.keys(voltages).forEach(function(voltage) {
              var sum = voltages[voltage]["rpm_indutive"].reduce(add, 0);
              voltages[voltage]["rpm_indutive"] = sum / voltages[voltage]["rpm_indutive"].length;

              sum = voltages[voltage]["rpm_optic"].reduce(add, 0);
              voltages[voltage]["rpm_optic"] = sum / voltages[voltage]["rpm_optic"].length;
            });

            Object.keys(voltages).forEach(function(voltage) {
              if(voltage == 3.3)
                data[0] = voltages[voltage]["rpm_indutive"];
              else if (voltage == 5)
                data[1] = voltages[voltage]["rpm_indutive"];
              else if (voltage == 9)
                data[2] = voltages[voltage]["rpm_indutive"];
              else if (voltage == 12)
                data[3] = voltages[voltage]["rpm_indutive"];
              else
                data[4] = voltages[voltage]["rpm_indutive"];
            });

            var dataset = {
              label           : 'Motor ' + currentKey,
              fill            : false,
              backgroundColor : 'rgb(255, 99, 132)',
              borderColor     : 'rgb(255, 99, 132)',
              data            : data
            };

            datasets.push(dataset);
          });

          // Create the chart.js data structure
          var config = {
            // The type of chart we want to create
            type: 'line',
            data: {
              labels : ["3.3 V", "5 V", "9 V", "12 V", "24 V"],
              datasets : datasets
            },
            options: {
              scales: {
                yAxes: [{
                  ticks: {
                    beginAtZero:true
                  }
                }]
              }
            }
          };

          // Get the context of the canvas element we want to select
          var ctx = document.getElementById("myCanvas").getContext("2d");

          // Instantiate a new chart
          var myLineChart = new Chart(ctx, config);
        });
      }

      // To use with reduce
      function add(a, b) {
          return a + b;
      }

      drawLineChart();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
  </body>
</html>
